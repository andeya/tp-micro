# Ant [![GitHub release](https://img.shields.io/github/release/henrylee2cn/tp-micro.svg?style=flat-square)](https://github.com/henrylee2cn/tp-micro/releases) [![report card](https://goreportcard.com/badge/github.com/henrylee2cn/tp-micro?style=flat-square)](http://goreportcard.com/report/henrylee2cn/tp-micro) [![github issues](https://img.shields.io/github/issues/henrylee2cn/tp-micro.svg?style=flat-square)](https://github.com/henrylee2cn/tp-micro/issues?q=is%3Aopen+is%3Aissue) [![github closed issues](https://img.shields.io/github/issues-closed-raw/henrylee2cn/tp-micro.svg?style=flat-square)](https://github.com/henrylee2cn/tp-micro/issues?q=is%3Aissue+is%3Aclosed) [![GoDoc](https://img.shields.io/badge/godoc-reference-blue.svg?style=flat-square)](http://godoc.org/github.com/henrylee2cn/tp-micro) [![view examples](https://img.shields.io/badge/learn%20by-examples-00BCD4.svg?style=flat-square)](https://github.com/henrylee2cn/tp-micro/tree/master/examples)
<!-- [![view Go网络编程群](https://img.shields.io/badge/官方QQ群-Go网络编程(42730308)-27a5ea.svg?style=flat-square)](http://jq.qq.com/?_wv=1027&k=fzi4p1) -->


TP-Micro 是一个基于 [Teleport](https://github.com/henrylee2cn/teleport) 定制的、简约而强大的微服务框架。


## 安装

```
go version ≥ 1.9
```

```sh
go get -u -f github.com/henrylee2cn/tp-micro
```

## 特性

- 支持服务自动发现
- 支持自定义服务链接选择器
- 支持负载均衡
- 支持多路复用IO及其连接池
- 支持自定义协议
- 支持自定义Body的编解码类型
- 支持插件扩展
- 支持心跳机制
- 日志信息详尽，支持打印输入、输出消息的详细信息（状态码、消息头、消息体）
- 支持设置慢操作报警阈值
- 支持自定义日志
- 支持平滑关闭与更新
- 支持推送
- 支持的网络类型：`tcp`、`tcp4`、`tcp6`、`unix`、`unixpacket`等
- 客户端支持断线后自动重连
- 支持过载保护（断路器）

## 平台方案

[Ants](https://github.com/xiaoenai/ants): 一套基于 [TP-Micro](https://github.com/henrylee2cn/tp-micro) 和 [Teleport](https://github.com/henrylee2cn/teleport) 的、高可用的微服务平台解决方案。

## 代码示例

- 服务端

```go
package main

import (
    micro "github.com/henrylee2cn/tp-micro"
    tp "github.com/henrylee2cn/teleport"
)

// Args args
type Args struct {
    A int
    B int `param:"<range:1:>"`
}

// P handler
type P struct {
    tp.PullCtx
}

// Divide divide API
func (p *P) Divide(args *Args) (int, *tp.Rerror) {
    return args.A / args.B, nil
}

func main() {
    srv := micro.NewServer(micro.SrvConfig{
        ListenAddress: ":9090",
    })
    srv.RoutePull(new(P))
    srv.ListenAndServe()
}
```

- 客户端

```go
package main

import (
    micro "github.com/henrylee2cn/tp-micro"
    tp "github.com/henrylee2cn/teleport"
)

func main() {
    cli := micro.NewClient(
        micro.CliConfig{},
        micro.NewStaticLinker(":9090"),
    )
    defer cli.Close()

    type Args struct {
        A int
        B int
    }

    var reply int
    rerr := cli.Pull("/p/divide", &Args{
        A: 10,
        B: 2,
    }, &reply).Rerror()
    if rerr != nil {
        tp.Fatalf("%v", rerr)
    }
    tp.Infof("10/2=%d", reply)
    rerr = cli.Pull("/p/divide", &Args{
        A: 10,
        B: 0,
    }, &reply).Rerror()
    if rerr == nil {
        tp.Fatalf("%v", rerr)
    }
    tp.Infof("test binding error: ok: %v", rerr)
}
```

[更多示例](https://github.com/henrylee2cn/tp-micro/tree/master/examples)


## 项目管理

- 快速创建项目
- 热编译模式运行项目

### 安装ant命令行

```sh
go get -u -f -d github.com/xiaoenai/ants/...
cd $GOPATH/src/github.com/xiaoenai/ants/cmd/ant
go install
```

### 生成项目

`ant gen` command help:

```
NAME:
     ant gen - Generate an ant project

USAGE:
     ant gen [command options] [arguments...]

OPTIONS:
     --template value, -t value    The template for code generation(relative/absolute)
     --app_path value, -p value  The path(relative/absolute) of the project
```

example: `ant gen -t ./__ant__tpl__.go -p ./myant` or default `ant gen myant`

- template file `__ant__tpl__.go` demo:

```go
// package __ANT__TPL__ is the project template
package __ANT__TPL__

// __API__PULL__ register PULL router:
//  /home
//  /math/divide
type __API__PULL__ interface {
    Home(*struct{}) *HomeReply
    Math
}

// __API__PUSH__ register PUSH router:
//  /stat
type __API__PUSH__ interface {
    Stat(*StatArgs)
}

// MODEL create model
type __MODEL__ struct {
    DivideArgs
}

// Math controller
type Math interface {
    // Divide handler
    Divide(*DivideArgs) *DivideReply
}

// HomeReply home reply
type HomeReply struct {
    Content string // text
}

type (
    // DivideArgs divide api args
    DivideArgs struct {
        // dividend
        A float64
        // divisor
        B float64 `param:"<range: 0.01:100000>"`
    }
    // DivideReply divide api result
    DivideReply struct {
        // quotient
        C float64
    }
)

// StatArgs stat handler args
type StatArgs struct {
    Ts int64 // timestamps
}
```

- The template generated by `ant gen` command.

```
├── README.md
├── main.go
├── config.go
├── api
│   ├── handlers.gen.go
│   ├── handlers.go
│   ├── router.gen.go
│   └── router.go
├── logic
│   ├── model
│   │   ├── init.go
│   │   └── xxx.gen.go
│   └── tmp_code.gen.go
├── rerrs
│   └── rerrs.go
├── sdk
│   ├── rpc.gen.go
│   ├── rpc.gen_test.go
│   ├── rpc.go
│   └── rpc_test.go
└── types
        ├── types.gen.go
        └── types.go
```


说明：

- 在自动生成的文件的文件名中增加 `.gen` 后缀进行标记
- `tmp_code.gen.go` 是为了通过编译而生成的临时文件，项目完成后应该移除它

[默认生成的示例](https://henrylee2cn/tp-micro/tree/master/examples/sample)

### 热编译运行

`ant run` 命令帮助：

```
NAME:
     ant run - Compile and run gracefully (monitor changes) an any existing go project

USAGE:
     ant run [options] [arguments...]
 or
     ant run [options except -app_path] [arguments...] {app_path}

OPTIONS:
     --watch_exts value, -x value  Specified to increase the listening file suffix (default: ".go", ".ini", ".yaml", ".toml", ".xml")
     --notwatch value, -n value    Not watch files or directories
     --app_path value, -p value    The path(relative/absolute) of the project
```

example: `ant run -x .yaml -p myant` or `ant run`

[更多 Ant 命令](https://github.com/xiaoenai/ants/tree/master/cmd/ant)


## 用法

### Peer端点（服务端或客户端）示例

```go
// Start a server
var peer1 = tp.NewPeer(tp.PeerConfig{
        ListenAddress: "0.0.0.0:9090", // for server role
})
peer1.Listen()

...

// Start a client
var peer2 = tp.NewPeer(tp.PeerConfig{})
var sess, err = peer2.Dial("127.0.0.1:8080")
```


### Pull-Controller-Struct 接口模板

```go
type Aaa struct {
        tp.PullCtx
}
func (x *Aaa) XxZz(args *<T>) (<T>, *tp.Rerror) {
        ...
        return r, nil
}
```

- 注册到根路由：

```go
// register the pull route: /aaa/xx_zz
peer.RoutePull(new(Aaa))

// or register the pull route: /xx_zz
peer.RoutePullFunc((*Aaa).XxZz)
```

### Pull-Handler-Function 接口模板

```go
func XxZz(ctx tp.PullCtx, args *<T>) (<T>, *tp.Rerror) {
        ...
        return r, nil
}
```

- 注册到根路由：

```go
// register the pull route: /xx_zz
peer.RoutePullFunc(XxZz)
```

### Push-Controller-Struct 接口模板

```go
type Bbb struct {
        tp.PushCtx
}
func (b *Bbb) YyZz(args *<T>) *tp.Rerror {
        ...
        return nil
}
```

- 注册到根路由：

```go
// register the push route: /bbb/yy_zz
peer.RoutePush(new(Bbb))

// or register the push route: /yy_zz
peer.RoutePushFunc((*Bbb).YyZz)
```

### Push-Handler-Function 接口模板

```go
// YyZz register the route: /yy_zz
func YyZz(ctx tp.PushCtx, args *<T>) *tp.Rerror {
        ...
        return nil
}
```

- 注册到根路由：

```go
// register the push route: /yy_zz
peer.RoutePushFunc(YyZz)
```

### Unknown-Pull-Handler-Function 接口模板

```go
func XxxUnknownPull (ctx tp.UnknownPullCtx) (interface{}, *tp.Rerror) {
        ...
        return r, nil
}
```

- 注册到根路由：

```go
// register the unknown pull route: /*
peer.SetUnknownPull(XxxUnknownPull)
```

### Unknown-Push-Handler-Function 接口模板

```go
func XxxUnknownPush(ctx tp.UnknownPushCtx) *tp.Rerror {
        ...
        return nil
}
```

- 注册到根路由：

```go
// register the unknown push route: /*
peer.SetUnknownPush(XxxUnknownPush)
```

### 结构体（函数）名称映射到URI路径的规则：

- `AaBb` -> `/aa_bb`
- `Aa_Bb` -> `/aa/bb`
- `aa_bb` -> `/aa/bb`
- `Aa__Bb` -> `/aa_bb`
- `aa__bb` -> `/aa_bb`
- `ABC_XYZ` -> `/abc/xyz`
- `ABcXYz` -> `/abc_xyz`
- `ABC__XYZ` -> `/abc_xyz`

### 插件示例

```go
// NewIgnoreCase Returns a ignoreCase plugin.
func NewIgnoreCase() *ignoreCase {
        return &ignoreCase{}
}

type ignoreCase struct{}

var (
        _ tp.PostReadPullHeaderPlugin = new(ignoreCase)
        _ tp.PostReadPushHeaderPlugin = new(ignoreCase)
)

func (i *ignoreCase) Name() string {
        return "ignoreCase"
}

func (i *ignoreCase) PostReadPullHeader(ctx tp.ReadCtx) *tp.Rerror {
        // Dynamic transformation path is lowercase
        ctx.UriObject().Path = strings.ToLower(ctx.UriObject().Path)
        return nil
}

func (i *ignoreCase) PostReadPushHeader(ctx tp.ReadCtx) *tp.Rerror {
        // Dynamic transformation path is lowercase
        ctx.UriObject().Path = strings.ToLower(ctx.UriObject().Path)
        return nil
}
```

### 注册以上操作和插件示例到路由

```go
// add router group
group := peer.SubRoute("test")
// register to test group
group.RoutePull(new(Aaa), NewIgnoreCase())
peer.RoutePullFunc(XxZz, NewIgnoreCase())
group.RoutePush(new(Bbb))
peer.RoutePushFunc(YyZz)
peer.SetUnknownPull(XxxUnknownPull)
peer.SetUnknownPush(XxxUnknownPush)
```

### 配置信息

```go
// SrvConfig server config
type SrvConfig struct {
        TlsCertFile       string        `yaml:"tls_cert_file"        ini:"tls_cert_file"        comment:"TLS certificate file path"`
        TlsKeyFile        string        `yaml:"tls_key_file"         ini:"tls_key_file"         comment:"TLS key file path"`
        DefaultSessionAge time.Duration `yaml:"default_session_age"  ini:"default_session_age"  comment:"Default session max age, if less than or equal to 0, no time limit; ns,µs,ms,s,m,h"`
        DefaultContextAge time.Duration `yaml:"default_context_age"  ini:"default_context_age"  comment:"Default PULL or PUSH context max age, if less than or equal to 0, no time limit; ns,µs,ms,s,m,h"`
        SlowCometDuration time.Duration `yaml:"slow_comet_duration"  ini:"slow_comet_duration"  comment:"Slow operation alarm threshold; ns,µs,ms,s ..."`
        DefaultBodyCodec  string        `yaml:"default_body_codec"   ini:"default_body_codec"   comment:"Default body codec type id"`
        PrintBody         bool          `yaml:"print_body"           ini:"print_body"           comment:"Is print body or not"`
        CountTime         bool          `yaml:"count_time"           ini:"count_time"           comment:"Is count cost time or not"`
        Network           string        `yaml:"network"              ini:"network"              comment:"Network; tcp, tcp4, tcp6, unix or unixpacket"`
        ListenAddress     string        `yaml:"listen_address"       ini:"listen_address"       comment:"Listen address; for server role"`
        EnableHeartbeat   bool          `yaml:"enable_heartbeat"     ini:"enable_heartbeat"     comment:"enable heartbeat"`
}

// CliConfig client config
type CliConfig struct {
        TlsCertFile         string        `yaml:"tls_cert_file"          ini:"tls_cert_file"          comment:"TLS certificate file path"`
        TlsKeyFile          string        `yaml:"tls_key_file"           ini:"tls_key_file"           comment:"TLS key file path"`
        DefaultSessionAge   time.Duration `yaml:"default_session_age"    ini:"default_session_age"    comment:"Default session max age, if less than or equal to 0, no time limit; ns,µs,ms,s,m,h"`
        DefaultContextAge   time.Duration `yaml:"default_context_age"    ini:"default_context_age"    comment:"Default PULL or PUSH context max age, if less than or equal to 0, no time limit; ns,µs,ms,s,m,h"`
        DefaultDialTimeout  time.Duration `yaml:"default_dial_timeout"   ini:"default_dial_timeout"   comment:"Default maximum duration for dialing; for client role; ns,µs,ms,s,m,h"`
        RedialTimes         int           `yaml:"redial_times"           ini:"redial_times"           comment:"The maximum times of attempts to redial, after the connection has been unexpectedly broken; for client role"`
        Failover            int           `yaml:"failover"               ini:"failover"               comment:"The maximum times of failover"`
        SlowCometDuration   time.Duration `yaml:"slow_comet_duration"    ini:"slow_comet_duration"    comment:"Slow operation alarm threshold; ns,µs,ms,s ..."`
        DefaultBodyCodec    string        `yaml:"default_body_codec"     ini:"default_body_codec"     comment:"Default body codec type id"`
        PrintBody           bool          `yaml:"print_body"             ini:"print_body"             comment:"Is print body or not"`
        CountTime           bool          `yaml:"count_time"             ini:"count_time"             comment:"Is count cost time or not"`
        Network             string        `yaml:"network"                ini:"network"                comment:"Network; tcp, tcp4, tcp6, unix or unixpacket"`
        HeartbeatSecond     int           `yaml:"heartbeat_second"       ini:"heartbeat_second"       comment:"When the heartbeat interval(second) is greater than 0, heartbeat is enabled; if it's smaller than 3, change to 3 default"`
        SessMaxQuota        int           `yaml:"sess_max_quota"         ini:"sess_max_quota"         comment:"The maximum number of sessions in the connection pool"`
        SessMaxIdleDuration time.Duration `yaml:"sess_max_idle_duration" ini:"sess_max_idle_duration" comment:"The maximum time period for the idle session in the connection pool; ns,µs,ms,s,m,h"`
}
```


### Binder

#### Param-Tags

tag   |   key    | required |     value     |   desc
------|----------|----------|---------------|----------------------------------
param |   query    | no |     -      | It indicates that the parameter is from the URI query part. e.g. `/a/b?x={query}`
param |   swap    | no |     -      | It indicates that the parameter is from the context swap.
param |   desc   |      no      |     (e.g.`id`)   | Parameter Description
param |   len    |      no      |   (e.g.`3:6`)  | Length range [a,b] of parameter's value
param |   range  |      no      |   (e.g.`0:10`)   | Numerical range [a,b] of parameter's value
param |  nonzero |      no      |    -    | Not allowed to zero
param |  regexp  |      no      |   (e.g.`^\w+$`)  | Regular expression validation
param |   rerr   |      no      |(e.g.`100002:wrong password format`)| Custom error code and message

NOTES:

* `param:"-"` means ignore
* Encountered untagged exportable anonymous structure field, automatic recursive resolution
* Parameter name is the name of the structure field converted to snake format
* If the parameter is not from `query` or `swap`, it is the default from the body

#### Field-Types

base    |   slice    | special
--------|------------|------------
string  |  []string  | [][]byte
byte    |  []byte    | [][]uint8
uint8   |  []uint8   | struct
bool    |  []bool    |
int     |  []int     |
int8    |  []int8    |
int16   |  []int16   |
int32   |  []int32   |
int64   |  []int64   |
uint8   |  []uint8   |
uint16  |  []uint16  |
uint32  |  []uint32  |
uint64  |  []uint64  |
float32 |  []float32 |
float64 |  []float64 |

#### 示例

```go
package main

import (
    tp "github.com/henrylee2cn/teleport"
    micro "github.com/henrylee2cn/tp-micro"
)

type (
    // Args args
    Args struct {
        A int
        B int `param:"<range:1:100>"`
        Query
        XyZ string `param:"<query><nonzero><rerr: 100002: Parameter cannot be empty>"`
    }
    Query struct {
        X string `param:"<query>"`
    }
)

// P handler
type P struct {
    tp.PullCtx
}

// Divide divide API
func (p *P) Divide(args *Args) (int, *tp.Rerror) {
    tp.Infof("query args x: %s, xy_z: %s", args.Query.X, args.XyZ)
    return args.A / args.B, nil
}

func main() {
    srv := micro.NewServer(micro.SrvConfig{
        ListenAddress:   ":9090",
        EnableHeartbeat: true,
    })
    group := srv.SubRoute("/static")
    group.RoutePull(new(P))
    srv.ListenAndServe()
}
```

[示例详情](https://github.com/henrylee2cn/tp-micro/tree/master/examples/binder)


### 通信优化

- SetPacketSizeLimit 设置包大小的上限，
    如果 maxSize<=0，上限默认为最大 uint32

        ```go
        func SetPacketSizeLimit(maxPacketSize uint32)
        ```

- SetSocketKeepAlive 是否允许操作系统的发送TCP的keepalive探测包

        ```go
        func SetSocketKeepAlive(keepalive bool)
        ```


- SetSocketKeepAlivePeriod 设置操作系统的TCP发送keepalive探测包的频度

        ```go
        func SetSocketKeepAlivePeriod(d time.Duration)
        ```

- SetSocketNoDelay 是否禁用Nagle算法，禁用后将不在合并较小数据包进行批量发送，默认为禁用

        ```go
        func SetSocketNoDelay(_noDelay bool)
        ```

- SetSocketReadBuffer 设置操作系统的TCP读缓存区的大小

        ```go
        func SetSocketReadBuffer(bytes int)
        ```

- SetSocketWriteBuffer 设置操作系统的TCP写缓存区的大小

        ```go
        func SetSocketWriteBuffer(bytes int)
        ```

[More Usage](https://github.com/henrylee2cn/teleport)


## 开源协议

Ant 项目采用商业应用友好的 [Apache2.0](https://github.com/henrylee2cn/tp-micro/raw/master/LICENSE) 协议发布
